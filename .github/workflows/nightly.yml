name: Nightly Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  nightly:
    name: Build and Release Nightly
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Build all platforms
        run: |
          zig build release-all

      - name: Package artifacts
        env:
          RELEASE_TARGETS: |
            x86_64-linux-gnu
            x86_64-linux-gnu-haswell
            x86_64-linux-musl
            aarch64-linux-gnu
            aarch64-linux-gnu-neoverse-n1
            aarch64-linux-gnu-rpi4
            x86_64-macos
            x86_64-macos-haswell
            aarch64-macos-m1
        run: |
          set -euo pipefail
          mkdir -p release-assets

          for target in $RELEASE_TARGETS; do
            src="zig-out/release/${target}"
            if [ ! -d "$src" ]; then
              echo "Skipping missing ${target}"
              continue
            fi
            mkdir -p "dist/${target}"

            for bin in flooc floos; do
              if [ -f "$src/${bin}.exe" ]; then
                cp "$src/${bin}.exe" "dist/${target}/${bin}.exe"
              elif [ -f "$src/${bin}" ]; then
                cp "$src/${bin}" "dist/${target}/${bin}"
              fi
            done

            cp README.md "dist/${target}/"
            cp configs/flooc.example.toml "dist/${target}/flooc.toml.example"
            cp configs/floos.example.toml "dist/${target}/floos.toml.example"

            if [[ "$target" == *"windows"* ]]; then
              (cd dist && zip -rq "../release-assets/floo-${target}.zip" "${target}")
            else
              (cd dist && tar czf "../release-assets/floo-${target}.tar.gz" "${target}")
            fi
          done

          ls -lh release-assets/

      - name: Delete old nightly release and tag
        run: |
          gh release delete nightly --yes || true
          git push origin :refs/tags/nightly || true
          git tag -d nightly || true
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create new nightly tag
        run: |
          git tag nightly
          git push origin nightly

      - name: Create nightly release
        run: |
          gh release create nightly \
            --title "Nightly Build ($(date +'%Y-%m-%d %H:%M UTC'))" \
            --notes "**Automated nightly build from latest commit**

          ## Latest Changes

          Commit: \`${{ github.sha }}\`

          $(git log -1 --pretty=format:'**%s**%n%n%b')

          ---

          ### üöÄ Performance
          - **29.4 Gbps** encrypted throughput (AEGIS-128L)
          - **671 KB** total binary size
          - **Zero dependencies**

          ### üì• Downloads

          | Platform | File | Recommended For |
          |----------|------|-----------------|
          | **Linux x86_64 (glibc)** | \`floo-x86_64-linux-gnu.tar.gz\` | Generic compatibility |
          | **Linux x86_64 (Haswell+)** | \`floo-x86_64-linux-gnu-haswell.tar.gz\` | Modern Intel/AMD (AES-NI) |
          | **Linux x86_64 (musl)** | \`floo-x86_64-linux-musl.tar.gz\` | Alpine/static containers |
          | **Linux ARM64 (generic)** | \`floo-aarch64-linux-gnu.tar.gz\` | ARM servers and SBCs |
          | **Linux ARM64 (Neoverse)** | \`floo-aarch64-linux-gnu-neoverse-n1.tar.gz\` | AWS Graviton / Ampere |
          | **Linux ARM64 (Raspberry Pi 4/5)** | \`floo-aarch64-linux-gnu-rpi4.tar.gz\` | Pi 4/5 tuned |
          | **macOS Apple Silicon** | \`floo-aarch64-macos-m1.tar.gz\` | M-series Macs |
          | **macOS Intel** | \`floo-x86_64-macos.tar.gz\` | Legacy Intel Macs |
          | **macOS Intel (Haswell+)** | \`floo-x86_64-macos-haswell.tar.gz\` | Best perf on 2013+ Macs |

          ### ‚ö†Ô∏è Note

          This is a **pre-release nightly build** from the latest code.
          - Updated automatically on every push to main
          - For production, use numbered releases (v0.1.0, v0.2.0, etc.)
          - Binaries are built with \`ReleaseFast\` optimization

          ### üîí Security

          Before using:
          1. Replace placeholder PSK/tokens in config files
          2. Run \`--doctor\` to validate setup
          3. Use AEGIS-128L or AES-256-GCM cipher

          ---

          **Built from:** ${{ github.repository }}@${{ github.sha }}
          " \
            --prerelease \
            release-assets/*
        env:
          GH_TOKEN: ${{ github.token }}
