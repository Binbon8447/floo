name: Nightly Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  nightly:
    name: Build and Release Nightly
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Build all platforms
        run: |
          # Build baseline
          zig build release-all -Drelease_cpu=baseline

          # Build Haswell-optimized
          mkdir -p zig-out/release-baseline
          cp -r zig-out/release/x86_64-linux-gnu zig-out/release-baseline/
          zig build release-all -Drelease_cpu=haswell
          mv zig-out/release/x86_64-linux-gnu zig-out/release/x86_64-linux-gnu-haswell
          mv zig-out/release-baseline/x86_64-linux-gnu zig-out/release/

      - name: Package artifacts
        run: |
          mkdir -p release-assets

          # Package each platform with descriptive names
          declare -A targets=(
            ["x86_64-linux-gnu"]="floo-x86_64-linux"
            ["x86_64-linux-gnu-haswell"]="floo-x86_64-linux-haswell"
            ["aarch64-linux-gnu"]="floo-aarch64-linux-rpi"
            ["x86_64-macos"]="floo-x86_64-macos"
            ["aarch64-macos"]="floo-aarch64-macos-m1"
          )

          for target in "${!targets[@]}"; do
            if [ -d "zig-out/release/$target" ]; then
              output_name="${targets[$target]}"
              mkdir -p "dist/$output_name"
              cp zig-out/release/$target/flooc "dist/$output_name/"
              cp zig-out/release/$target/floos "dist/$output_name/"
              cp README.md flooc.toml.example floos.toml.example "dist/$output_name/"

              # Create tarball with descriptive name
              cd dist
              tar czf "../release-assets/${output_name}.tar.gz" "$output_name/"
              cd ..
            fi
          done

          ls -lh release-assets/

      - name: Delete old nightly release
        run: |
          gh release delete nightly --yes || true
          git push origin :refs/tags/nightly || true
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create nightly release
        run: |
          gh release create nightly \
            --title "Nightly Build ($(date +'%Y-%m-%d %H:%M UTC'))" \
            --notes "**Automated nightly build from latest commit**

          ## Latest Changes

          Commit: \`${{ github.sha }}\`

          $(git log -1 --pretty=format:'**%s**%n%n%b')

          ---

          ### üöÄ Performance
          - **29.4 Gbps** encrypted throughput (AEGIS-128L)
          - **671 KB** total binary size
          - **Zero dependencies**

          ### üì• Downloads

          | Platform | File | Recommended For |
          |----------|------|-----------------|
          | **Raspberry Pi / ARM64 Linux** | \`floo-aarch64-linux-rpi.tar.gz\` | Raspberry Pi 3/4/5, ARM servers |
          | **Linux x86_64 (Haswell+)** | \`floo-x86_64-linux-haswell.tar.gz\` | Modern Intel/AMD (2013+) with AES-NI |
          | **Linux x86_64 (Generic)** | \`floo-x86_64-linux.tar.gz\` | Older/generic x86_64 CPUs |
          | **macOS Apple Silicon** | \`floo-aarch64-macos-m1.tar.gz\` | M1/M2/M3/M4 Macs |
          | **macOS Intel** | \`floo-x86_64-macos.tar.gz\` | Intel Macs |

          ### ‚ö†Ô∏è Note

          This is a **pre-release nightly build** from the latest code.
          - Updated automatically on every push to main
          - For production, use numbered releases (v0.1.0, v0.2.0, etc.)
          - Binaries are built with \`ReleaseFast\` optimization

          ### üîí Security

          Before using:
          1. Replace placeholder PSK/tokens in config files
          2. Run \`--doctor\` to validate setup
          3. Use AEGIS-128L or AES-256-GCM cipher

          ---

          **Built from:** ${{ github.repository }}@${{ github.sha }}
          " \
            --prerelease \
            release-assets/*.tar.gz
        env:
          GH_TOKEN: ${{ github.token }}
