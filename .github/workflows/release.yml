name: Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Run tests
        run: zig build test

      - name: Build and test native
        run: |
          zig build -Doptimize=ReleaseFast
          ./zig-out/bin/flooc --version
          ./zig-out/bin/floos --version

  cross-compile:
    name: Cross-Compile Release Binaries
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Build all platforms
        run: |
          zig build release-all

          echo "Built binaries:"
          find zig-out/release -maxdepth 2 -type f \( -name "flooc*" -o -name "floos*" \) | sort

      - name: Package artifacts
        env:
          RELEASE_TARGETS: |
            x86_64-linux-gnu
            x86_64-linux-gnu-haswell
            x86_64-linux-musl
            aarch64-linux-gnu
            aarch64-linux-gnu-neoverse-n1
            aarch64-linux-gnu-rpi4
            x86_64-macos
            x86_64-macos-haswell
            aarch64-macos-m1
        run: |
          set -euo pipefail
          mkdir -p artifacts

          for target in $RELEASE_TARGETS; do
            src="zig-out/release/${target}"
            if [ ! -d "$src" ]; then
              echo "Warning: target ${target} missing, skipping"
              continue
            fi

            out_dir="artifacts/${target}"
            mkdir -p "$out_dir"

            for bin in flooc floos; do
              if [ -f "$src/${bin}.exe" ]; then
                cp "$src/${bin}.exe" "$out_dir/${bin}.exe"
              elif [ -f "$src/${bin}" ]; then
                cp "$src/${bin}" "$out_dir/${bin}"
              else
                echo "Warning: $bin not found for ${target}"
              fi
            done

            cp README.md "$out_dir/"
            cp configs/flooc.example.toml "$out_dir/flooc.toml.example"
            cp configs/floos.example.toml "$out_dir/floos.toml.example"
            cp CHANGELOG.md "$out_dir/" 2>/dev/null || true

            if [[ "$target" == *"windows"* ]]; then
              (cd artifacts && zip -rq "floo-${target}.zip" "${target}")
            else
              (cd artifacts && tar czf "floo-${target}.tar.gz" "${target}")
            fi
          done

          echo "Created release payloads:"
          ls -lh artifacts

      - name: Upload release packages
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: artifacts

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: cross-compile
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify version matches tag
        run: |
          # Extract version from build.zig.zon
          VERSION=$(grep -oP '\.version = "\K[^"]+' build.zig.zon)
          # Extract version from git tag (remove 'v' prefix)
          TAG_VERSION=${GITHUB_REF#refs/tags/v}

          echo "build.zig.zon version: $VERSION"
          echo "Git tag version: $TAG_VERSION"

          if [ "$VERSION" != "$TAG_VERSION" ]; then
            echo "‚ùå ERROR: Version mismatch!"
            echo "   build.zig.zon has version '$VERSION'"
            echo "   Git tag is 'v$TAG_VERSION'"
            echo ""
            echo "Please update build.zig.zon to version \"$TAG_VERSION\" before creating this release."
            exit 1
          fi

          echo "‚úÖ Version match confirmed: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find release-artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-assets/ \;
          ls -lh release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Floo ${{ github.ref_name }}

            **High-throughput tunneling in Zig - Zero dependencies, maximum performance**

            ### üöÄ Performance (Apple M1 MacBook Air)
            - **29.4 Gbps** encrypted throughput (AEGIS-128L cipher)
            - **62% faster** than Rathole
            - **194% faster** than FRP

            ### üì¶ Binary Sizes
            - Client (`flooc`): 394 KB
            - Server (`floos`): 277 KB
            - **Total: 671 KB**

            ### ‚ú® Key Features
            - üîê Noise XX + PSK authentication (5 AEAD ciphers)
            - üöÄ Multi-service multiplexing
            - ‚ö° Parallel tunnels with round-robin load balancing
            - üåê Proxy support (SOCKS5 + HTTP CONNECT)
            - üíì Heartbeat supervision & auto-reconnect
            - üîÑ Hot config reload (SIGHUP)
            - üìä Built-in diagnostics (`--doctor`, `--ping`)
            - üéØ Per-service token authentication

            ### üì• Installation

            **Choose your platform:**

            | Platform | Download | CPU Optimization |
            |----------|----------|------------------|
            | **Linux x86_64 (glibc)** | `floo-x86_64-linux-gnu.tar.gz` | Generic compatibility |
            | **Linux x86_64 (Haswell+)** ‚ö° | `floo-x86_64-linux-gnu-haswell.tar.gz` | AES-NI/BMI2 tuned |
            | **Linux x86_64 (static)** | `floo-x86_64-linux-musl.tar.gz` | Works on Alpine / scratch containers |
            | **Linux ARM64 (generic)** | `floo-aarch64-linux-gnu.tar.gz` | ARM servers, Jetson |
            | **Linux ARM64 (Neoverse)** ‚ö° | `floo-aarch64-linux-gnu-neoverse-n1.tar.gz` | Graviton / Ampere instances |
            | **Linux ARM64 (Raspberry Pi 4/5)** ü•ß | `floo-aarch64-linux-gnu-rpi4.tar.gz` | Tuned for Cortex-A72 |
            | **macOS Intel** | `floo-x86_64-macos.tar.gz` | macOS 11+ universal baseline |
            | **macOS Intel (Haswell+)** ‚ö° | `floo-x86_64-macos-haswell.tar.gz` | Best perf on 2013+ Macs |
            | **macOS Apple Silicon** | `floo-aarch64-macos-m1.tar.gz` | M1/M2/M3/M4 with ARMv8 crypto |

            ‚ö° **Recommended:** Optimized builds provide significantly better crypto performance (3-5x faster encryption).

            ü•ß **Raspberry Pi users:** Use the `aarch64-linux-gnu-rpi` variant to avoid illegal instruction errors on Pi 4/5.

            **Extract and use:**
            ```bash
            tar xzf floo-*.tar.gz   # or unzip floo-*.zip on Windows
            cd floo-*/
            ./flooc --version
            ./floos --version
            ```

            ### üìñ Quick Start

            See the [README](https://github.com/${{ github.repository }}) for complete documentation including:
            - Configuration guide
            - CLI reference
            - Performance tuning
            - Proxy setup
            - Troubleshooting

            ### ‚ö†Ô∏è Security Note

            Before production use:
            1. Replace placeholder PSK and tokens in config files
            2. Run `--doctor` diagnostics to validate setup
            3. Use AEGIS-128L or AES-256-GCM cipher (never "none")

            ---

            **Built with ‚ù§Ô∏è in Zig**
